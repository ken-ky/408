### 五段式指令流水线

指令流水线的基本概念【概念】；指令流水线的基本实现【只考五段式】；

结构冒险、数据冒险和控制冒险的处理【结合MIPS指令序列分析并处理冒险（重点和难点）】；

超标量和动态流水线的基本概念【概念】



#### 概念内容再整理

+ 流水线吞吐率（TP）：单位时间内流水线完成的任务数量，或输出结果的数量
  + $TP=\frac{n}{T_k}$（n为任务数，T~k~为处理完n个任务所花时间）
  + 理想情况，一条k段流水线能在k+n-1个时钟周期完成n个任务
+ 加速比（S）：不使用流水线时间和使用流水线时间的比
  + $S=\frac{T_0}{T_k}$（T~0~表示不使用流水线的总时间）
+ 高级流水线技术
  + 超标量流水线技术（动态多发射）：**不能调整指令执行顺序**，每个时钟周期可并发多条独立指令
    + 乱序执行：指令不按顺序执行
  + 超长指令字技术（静态多发射）：编译程序完成将多条可并行的操作合并为一条多操作码字段的超长指令字（**需要多个处理部件支持**）
  + 超流水线技术：**不能调整指令执行顺序**，将流水线功能划分为多段并发执行（一个时钟周期内，一个功能部件用多次）
+ 并发分级
  + 部件功能级：按算术逻辑运算划分功能段
  + 处理机级：一条指令解释划分多个子过程
  + 处理机间级：每个CPU完成其中某一专门任务，所得结果移交下一CPU所共享存储器中



#### 考点分析

+ 分析指令流水线是否发生冒险，以及冒险的处理

  + 结构冒险（少）
  + 数据冒险——最常考（MIPS）
  + 控制冒险——较常考（MIPS）

+ 数据冒险：

  + 分析是否存在数据冒险

    + 特点：两条指令，前“写”后“读”（观察是否有写寄存器、后续连续三条是否有读**同一个寄存器**）【因为第四条执行时已经写完了】

  + 常见数据冒险处理方法

    + 硬件阻塞：将“读寄存器指令”的ID段硬件放在WB段之后

      【注】之后的指令都会被阻塞，因为占用了IF的硬件资源，故全被阻塞

    + 旁路技术（少）

      + 转发（旁路技术）可以解决大部分数据冒险【使用了特殊线路，提前做完EX段内容给后续指令的ID段】
      + 但**不能解决由Load指令写寄存器引起的Load-use数据冒险**【但是Load指令只有在WB段才会写回对应单元】

+ 控制冒险

  + 分析是否存在控制冒险

    只有**转移类指令**会引发（关注条件转移类），在执行时流水预载了后几行指令（但是实际PC指向了另一地址的指令）

  + 常见解决方法：

    + 硬件阻塞：将转移类指令后一指令的**IF段硬件阻塞3个时钟**【但是要考虑是否同时存在了数据冒险】





#### 五段式流水

+ 五段式：IF 取指、ID 译码/取数、EX 执行/计算地址、M 访存、WB 写回

+ IF和M使用到同一段Cache，会发生结构冒险（资源冲突）
  + 进行阻塞
  + 将指令Cache和数据Cache分离

+ 数据冒险（例）：

  $I_1:985\to R_1(985)$

  $I_2:R_1+1\to R_2(986)$

  引入流水线后发生了同时读写同一单元问题

+ 控制冒险（例）

  PC指向下一条执行指令，但是在执行跳转指令时会更改PC值，